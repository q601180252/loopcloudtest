# 更新代码签名证书指南

## 问题描述

如果遇到以下错误：
```
Signing certificate is invalid. Signing certificate "Apple Distribution: Yang Li (***)", 
serial number "525FA5897189569795472C923D76FFAD", is not valid for code signing. 
It may have been revoked or expired.
```

这表示代码签名证书已过期或被撤销，需要更新。

## 更新方法

### 方法 1：使用 GitHub Actions（推荐）

#### 步骤 1：设置强制更新变量

1. 进入你的 GitHub 仓库
2. 点击 **Settings** → **Secrets and variables** → **Actions**
3. 切换到 **Variables** 标签
4. 点击 **New repository variable**
5. 添加变量：
   - **Name**: `FORCE_NUKE_CERTS`
   - **Value**: `true`
6. 点击 **Add variable**

#### 步骤 2：运行证书创建 Workflow

1. 进入 **Actions** 标签
2. 在左侧选择 **"3. Create Certificates"** workflow
3. 点击 **Run workflow** 按钮
4. 选择分支（通常是 `main`）
5. 点击绿色的 **Run workflow** 按钮

#### 步骤 3：等待完成

Workflow 会执行以下操作：
1. 检查证书状态
2. 删除（nuke）旧的证书和 provisioning profiles
3. 创建新的证书和 provisioning profiles
4. 将新证书保存到 Match-Secrets 仓库

#### 步骤 4：清理变量（重要！）

证书更新完成后，**必须**删除或禁用 `FORCE_NUKE_CERTS` 变量：

1. 回到 **Settings** → **Secrets and variables** → **Actions** → **Variables**
2. 找到 `FORCE_NUKE_CERTS` 变量
3. 点击右侧的 **...** 菜单
4. 选择 **Delete** 或将其值改为 `false`

**注意**：如果不清理这个变量，每次运行都会删除并重新创建证书，这会导致构建失败。

### 方法 2：使用自动检测（如果已启用）

如果你的仓库中设置了 `ENABLE_NUKE_CERTS=true` 变量：

1. 运行 **"4. Build Loop"** workflow
2. 构建流程会自动检测证书是否过期
3. 如果检测到过期，会自动删除旧证书并创建新证书

### 方法 3：本地运行 Fastlane（需要本地环境）

如果你有本地开发环境，可以在本地运行：

```bash
# 1. 删除旧证书
bundle exec fastlane nuke_certs

# 2. 创建新证书
bundle exec fastlane certs
```

**注意**：需要设置以下环境变量：
- `TEAMID`
- `FASTLANE_KEY_ID`
- `FASTLANE_ISSUER_ID`
- `FASTLANE_KEY`
- `GH_PAT`
- `MATCH_PASSWORD`
- `GITHUB_REPOSITORY_OWNER`

## 验证证书更新

证书更新完成后，可以通过以下方式验证：

1. **检查 Match-Secrets 仓库**：
   - 进入你的 `Match-Secrets` 仓库
   - 查看 `certs/distribution/` 目录
   - 应该看到新的证书文件

2. **运行构建**：
   - 运行 **"4. Build Loop"** workflow
   - 如果构建成功，说明证书已正确更新

## 自动修复证书不匹配问题

如果你遇到以下错误：
```
Certificate 'XXXXX' (stored in your storage) is not available on the Developer Portal
```

**好消息**：`certs` lane 现在会自动处理这种情况！

当你运行 `bundle exec fastlane certs` 或 "3. Create Certificates" workflow 时，系统会：
1. 检测到证书不匹配
2. 自动清理（nuke）旧证书
3. 自动创建新证书

**无需手动操作**，只需重新运行证书创建流程即可。

## 常见问题

### Q: 证书更新后构建仍然失败？

A: 检查以下几点：
1. 确认 `FORCE_NUKE_CERTS` 变量已删除或设为 `false`
2. 确认 Match-Secrets 仓库中有新的证书文件
3. 检查 App Store Connect API Key 是否有效
4. 查看构建日志中的具体错误信息

### Q: 遇到 "Certificate not available on Developer Portal" 错误怎么办？

A: 现在系统会自动处理！只需：
1. 重新运行 **"3. Create Certificates"** workflow
2. 系统会自动检测并清理不匹配的证书
3. 然后创建新证书

如果自动修复失败，可以手动设置 `FORCE_NUKE_CERTS=true` 变量，然后运行证书创建 workflow。

### Q: 可以手动在 Apple Developer Portal 创建证书吗？

A: 可以，但不推荐。使用 `match` 工具可以确保：
- 证书和 provisioning profiles 同步
- 团队成员共享相同的证书
- 自动管理证书生命周期

如果手动创建，需要：
1. 在 Apple Developer Portal 创建新证书
2. 下载并安装到本地
3. 更新 Match-Secrets 仓库
4. 更新所有 provisioning profiles

### Q: 证书多久需要更新一次？

A: Apple Distribution 证书通常有效期为 1 年。建议：
- 在证书过期前 1-2 个月更新
- 设置 `ENABLE_NUKE_CERTS=true` 启用自动检测
- 定期检查证书状态

## 相关文件

- `fastlane/Fastfile` - Fastlane 配置，包含证书管理 lanes
- `.github/workflows/3_create_certificates.yml` - 证书创建 workflow
- `.github/workflows/4_build_loop.yml` - 构建 workflow（包含证书检查）

## 注意事项

⚠️ **重要**：
- 更新证书会删除所有旧的证书和 provisioning profiles
- 确保在更新前备份重要数据
- 更新后，所有团队成员需要重新同步证书
- 不要在生产环境中频繁更新证书


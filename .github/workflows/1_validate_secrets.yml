name: 1. Validate Secrets
run-name: Validate Secrets
on:
  workflow_dispatch:

jobs:
  validate:
    name: Validate
    runs-on: macos-15
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Validate Fastlane Secrets
        run: |
          if [ -z "$TEAMID" ]; then
            echo "Error: TEAMID secret is not set"
            exit 1
          fi
          if [ -z "$FASTLANE_ISSUER_ID" ]; then
            echo "Error: FASTLANE_ISSUER_ID secret is not set"
            exit 1
          fi
          if [ -z "$FASTLANE_KEY_ID" ]; then
            echo "Error: FASTLANE_KEY_ID secret is not set"
            exit 1
          fi
          if [ -z "$FASTLANE_KEY" ]; then
            echo "Error: FASTLANE_KEY secret is not set"
            exit 1
          fi
          if [ -z "$GH_PAT" ]; then
            echo "Error: GH_PAT secret is not set"
            exit 1
          fi
          if [ -z "$MATCH_PASSWORD" ]; then
            echo "Error: MATCH_PASSWORD secret is not set"
            exit 1
          fi
          echo "✅ All required secrets are configured"
        env:
          TEAMID: ${{ secrets.TEAMID }}
          FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
          FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
          FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Run Fastlane Validate Secrets
        run: bundle exec fastlane validate_secrets
        env:
          TEAMID: ${{ secrets.TEAMID }}
          FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
          FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
          FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}

      - name: Validation Success
        run: |
          echo "=========================================="
          echo "✅ All secrets validated successfully!"
          echo "=========================================="
          echo ""
          echo "Next steps:"
          echo "1. Run '2. Add Identifiers' workflow"
          echo "2. Manually configure App Group and capabilities in Apple Developer Portal"
          echo "3. Run '3. Create Certificates' workflow"
          echo "4. Run '4. Build Loop' workflow"


name: 4. Build Loop
run-name: Build Loop
on:
  workflow_dispatch:
  schedule:
    # Weekly check for updates - Wednesdays at 08:00 UTC
    - cron: '0 8 * * 3'
    # Monthly build - 1st of month at 06:00 UTC
    - cron: '0 6 1 * *'

jobs:
  # Keep repository alive by committing to alive branch
  keep_alive:
    name: Keep Alive
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && vars.SCHEDULED_BUILD != 'false' && vars.SCHEDULED_SYNC != 'false'
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          ref: alive

      - name: Keep Alive Commit
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create dummy commit
          echo "Keep alive commit on $(date)" >> keep_alive.txt
          git add keep_alive.txt
          git commit -m "Keep alive: $(date)" || echo "No changes to commit"
          
          # Push changes
          git push origin alive
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

  # Check for updates and sync repository
  check_update:
    name: Check for Updates
    runs-on: ubuntu-latest
    if: (github.event_name == 'schedule' && vars.SCHEDULED_SYNC != 'false') || github.event_name == 'workflow_dispatch'
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Updates
        id: check
        run: |
          # Fetch latest from upstream
          git remote add upstream https://github.com/LoopKit/LoopWorkspace.git || true
          git fetch upstream
          
          # Check if there are new commits
          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse upstream/main)
          
          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "Updates found!"
            echo "should_build=true" >> $GITHUB_OUTPUT
            
            # Sync with upstream if this is a scheduled run
            if [ "${{ github.event_name }}" = "schedule" ]; then
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git merge upstream/main --no-edit
              git push origin main
            fi
          else
            echo "No updates found"
            # Monthly build should always build
            if [ "${{ github.event.schedule }}" = "0 6 1 * *" ]; then
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          fi

  # Check and renew certificates if needed
  check_certs:
    name: Check Certificates
    runs-on: macos-15
    if: needs.check_update.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    needs: check_update
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Check and Renew Certificates
        if: vars.ENABLE_NUKE_CERTS == 'true'
        run: |
          bundle exec fastlane check_and_renew_certificates
          
          if [ -f "new_certificate_needed.txt" ]; then
            NEED_NUKE=$(cat new_certificate_needed.txt)
            if [ "$NEED_NUKE" = "true" ]; then
              echo "⚠️  Certificates need renewal"
              bundle exec fastlane nuke_certs
              bundle exec fastlane certs
            fi
          fi
        env:
          TEAMID: ${{ secrets.TEAMID }}
          FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
          FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
          FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}

  # Build Loop
  build:
    name: Build
    runs-on: macos-15
    if: needs.check_update.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    needs: [check_update, check_certs]
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Verify Xcode Setup
        run: |
          echo "=========================================="
          echo "Xcode Setup"
          echo "=========================================="
          echo "Selected Xcode version:"
          xcodebuild -version
          xcrun --sdk iphoneos --show-sdk-version
          
          echo ""
          echo "Available iOS SDKs:"
          xcodebuild -showsdks | grep -i ios
          
          echo ""
          echo "=========================================="
      
      - name: Install iOS Platform
        run: |
          echo "=========================================="
          echo "Installing iOS Platform"
          echo "=========================================="
          
          # Accept Xcode license if needed
          sudo xcodebuild -license accept || echo "License may already be accepted"
          
          # Run Xcode first launch to install necessary components (multiple times to ensure completion)
          echo "Running Xcode first launch..."
          for i in {1..3}; do
            echo "First launch attempt $i..."
            sudo xcodebuild -runFirstLaunch || true
            sleep 5
          done
          
          # Wait for initialization
          echo "Waiting for Xcode initialization..."
          sleep 15
          
          # Try to install all platforms first (more reliable)
          echo ""
          echo "Attempting to download all platforms..."
          sudo xcodebuild -downloadAllPlatforms 2>&1 || echo "⚠️ downloadAllPlatforms failed, trying individual platform install..."
          
          # Wait for download to complete
          sleep 10
          
          # Install iOS platform specifically (multiple attempts)
          echo ""
          echo "Installing iOS platform..."
          for i in {1..3}; do
            echo "iOS platform install attempt $i..."
            if sudo xcodebuild -downloadPlatform iOS 2>&1; then
              echo "✅ iOS platform install succeeded on attempt $i"
              break
            else
              echo "⚠️ iOS platform install attempt $i failed"
              sleep 10
            fi
          done
          
          # Additional wait for platform to be fully registered
          sleep 15
          
          # Verify platform installation
          echo ""
          echo "Verifying platform installation..."
          XCODE_PATH=$(xcode-select -p | sed 's|/Contents/Developer||')
          IOS_PLATFORM_PATH="$XCODE_PATH/Contents/Developer/Platforms/iPhoneOS.platform"
          
          if [ -d "$IOS_PLATFORM_PATH" ]; then
            echo "✅ iOS platform directory exists: $IOS_PLATFORM_PATH"
            ls -la "$IOS_PLATFORM_PATH" | head -5
            
            # Verify key files
            if [ -f "$IOS_PLATFORM_PATH/Info.plist" ]; then
              echo "✅ iOS platform Info.plist exists"
            else
              echo "❌ iOS platform Info.plist missing"
              exit 1
            fi
            
            if [ -d "$IOS_PLATFORM_PATH/Developer/SDKs" ]; then
              echo "✅ iOS platform SDKs directory exists"
              SDK_COUNT=$(ls -1 "$IOS_PLATFORM_PATH/Developer/SDKs" 2>/dev/null | wc -l | tr -d ' ')
              echo "✅ Found $SDK_COUNT iOS SDK(s)"
              ls -1 "$IOS_PLATFORM_PATH/Developer/SDKs" 2>/dev/null || echo "⚠️ Cannot list SDKs"
            else
              echo "❌ iOS platform SDKs directory missing"
              exit 1
            fi
          else
            echo "❌ iOS platform directory not found: $IOS_PLATFORM_PATH"
            exit 1
          fi
          
          # Force Xcode to refresh platform cache by checking first launch status
          echo ""
          echo "Checking Xcode first launch status..."
          sudo xcodebuild -checkFirstLaunchStatus || echo "⚠️ First launch check failed"
          
          # Test destination detection with explicit SDK
          echo ""
          echo "Testing destination detection..."
          echo "Available destinations:"
          xcodebuild -showsdks 2>&1 | grep -i "iphoneos" || echo "⚠️ Cannot show iOS SDKs"
          
          # Try to show destinations for the workspace
          if [ -f "LoopWorkspace.xcworkspace/contents.xcworkspacedata" ]; then
            echo ""
            echo "Testing workspace destination detection..."
            DEST_OUTPUT=$(xcodebuild -workspace LoopWorkspace.xcworkspace -scheme LoopWorkspace -showdestinations -configuration Release 2>&1)
            if echo "$DEST_OUTPUT" | grep -qi "iOS"; then
              echo "✅ Found iOS destinations:"
              echo "$DEST_OUTPUT" | grep -i "iOS" | head -3
            else
              echo "⚠️ No iOS destinations found in workspace"
              echo "Full output:"
              echo "$DEST_OUTPUT" | head -20
            fi
          fi
          
          echo ""
          echo "=========================================="
      
      - name: Install watchOS Platform
        run: |
          echo "=========================================="
          echo "Installing watchOS Platform"
          echo "=========================================="
          
          # Install watchOS platform (multiple attempts)
          echo "Installing watchOS platform..."
          for i in {1..3}; do
            echo "watchOS platform install attempt $i..."
            if sudo xcodebuild -downloadPlatform watchOS 2>&1; then
              echo "✅ watchOS platform install succeeded on attempt $i"
              break
            else
              echo "⚠️ watchOS platform install attempt $i failed"
              sleep 10
            fi
          done
          
          # Additional wait for platform to be fully registered
          sleep 15
          
          # Verify watchOS platform installation
          echo ""
          echo "Verifying watchOS platform installation..."
          XCODE_PATH=$(xcode-select -p | sed 's|/Contents/Developer||')
          WATCHOS_PLATFORM_PATH="$XCODE_PATH/Contents/Developer/Platforms/WatchOS.platform"
          
          if [ -d "$WATCHOS_PLATFORM_PATH" ]; then
            echo "✅ watchOS platform directory exists: $WATCHOS_PLATFORM_PATH"
            ls -la "$WATCHOS_PLATFORM_PATH" | head -5
            
            # Verify key files
            if [ -f "$WATCHOS_PLATFORM_PATH/Info.plist" ]; then
              echo "✅ watchOS platform Info.plist exists"
            else
              echo "❌ watchOS platform Info.plist missing"
              exit 1
            fi
            
            if [ -d "$WATCHOS_PLATFORM_PATH/Developer/SDKs" ]; then
              echo "✅ watchOS platform SDKs directory exists"
              SDK_COUNT=$(ls -1 "$WATCHOS_PLATFORM_PATH/Developer/SDKs" 2>/dev/null | wc -l | tr -d ' ')
              echo "✅ Found $SDK_COUNT watchOS SDK(s)"
              ls -1 "$WATCHOS_PLATFORM_PATH/Developer/SDKs" 2>/dev/null || echo "⚠️ Cannot list SDKs"
            else
              echo "❌ watchOS platform SDKs directory missing"
              exit 1
            fi
          else
            echo "❌ watchOS platform directory not found: $WATCHOS_PLATFORM_PATH"
            exit 1
          fi
          
          # Test watchOS SDK availability
          echo ""
          echo "Testing watchOS SDK availability..."
          echo "Available watchOS SDKs:"
          xcodebuild -showsdks 2>&1 | grep -i "watchos" || echo "⚠️ Cannot show watchOS SDKs"
          
          # Verify watchOS SDK version
          WATCHOS_SDK_VERSION=$(xcrun --sdk watchos --show-sdk-version 2>/dev/null || echo "")
          if [ -z "$WATCHOS_SDK_VERSION" ]; then
            echo "⚠️ watchOS SDK version not found"
          else
            echo "✅ watchOS SDK version: $WATCHOS_SDK_VERSION"
          fi
          
          echo ""
          echo "=========================================="
      
      - name: Workaround iOS 18.0 Platform Issue
        run: |
          echo "Attempting to create iOS 18.0 platform symlink from iOS 18.4..."
          PLATFORMS_DIR="/Applications/Xcode_16.app/Contents/Developer/Platforms"
          IOS_PLATFORM="$PLATFORMS_DIR/iPhoneOS.platform"
          
          # Check if iOS 18.4 runtime exists
          if [ -d "$HOME/Library/Developer/CoreSimulator/Runtimes" ]; then
            echo "Available runtimes:"
            ls -la "$HOME/Library/Developer/CoreSimulator/Runtimes/" || true
          fi
          
          # Try to copy iOS 18.4 runtime to 18.0
          RUNTIME_DIR="$HOME/Library/Developer/CoreSimulator/Runtimes"
          if [ -d "$RUNTIME_DIR" ]; then
            # Find iOS 18.4 runtime
            IOS_18_4=$(ls "$RUNTIME_DIR" | grep "iOS.*18.*4" | head -1)
            if [ -n "$IOS_18_4" ]; then
              echo "Found iOS 18.4 runtime: $IOS_18_4"
              # Create a symlink for iOS 18.0
              IOS_18_0_NAME=$(echo "$IOS_18_4" | sed 's/18\.4/18.0/')
              if [ ! -e "$RUNTIME_DIR/$IOS_18_0_NAME" ]; then
                sudo ln -s "$RUNTIME_DIR/$IOS_18_4" "$RUNTIME_DIR/$IOS_18_0_NAME" || true
                echo "Created symlink: $IOS_18_0_NAME -> $IOS_18_4"
              fi
            fi
          fi
          
          echo "Workaround complete"

      - name: Fix Swift 6 Compatibility for Xcode 15.4
        run: |
          echo "Removing @retroactive attributes for Xcode 15.4 compatibility..."
          
          # Remove @retroactive from all Swift files
          find Loop -name "*.swift" -type f -exec grep -l "@retroactive" {} \; | while read file; do
            echo "Fixing $file..."
            sed -i '' 's/@retroactive //g' "$file"
          done
          
          echo "✅ Swift 6 compatibility fixes applied"

      - name: Fix WatchApp Bundle ID Configuration
        run: |
          echo "Fixing WatchApp and WatchApp Extension Bundle ID configuration..."
          
          MAIN_BUNDLE_ID="com.libre.loopkit3.Loop"
          
          # Fix WKAppBundleIdentifier in WatchApp Extension Info.plist
          WATCH_EXTENSION_PLIST="Loop/WatchApp Extension/Info.plist"
          if [ -f "$WATCH_EXTENSION_PLIST" ]; then
            sed -i '' "s/\$(MAIN_APP_BUNDLE_IDENTIFIER)/${MAIN_BUNDLE_ID}/g" "$WATCH_EXTENSION_PLIST"
            echo "✅ Fixed WatchApp Extension Info.plist"
            grep "WKAppBundleIdentifier" -A 1 "$WATCH_EXTENSION_PLIST"
          fi
          
          # Fix WKCompanionAppBundleIdentifier in WatchApp Info.plist
          WATCH_APP_PLIST="Loop/WatchApp/Info.plist"
          if [ -f "$WATCH_APP_PLIST" ]; then
            sed -i '' "s/\$(MAIN_APP_BUNDLE_IDENTIFIER)/${MAIN_BUNDLE_ID}/g" "$WATCH_APP_PLIST"
            echo "✅ Fixed WatchApp Info.plist"
            grep "WKCompanionAppBundleIdentifier" -A 1 "$WATCH_APP_PLIST"
          fi
          
          echo "✅ WatchApp Bundle ID configuration fixed"

      - name: Create NotificationHelperOverride.swift
        run: |
          cat > LibreTransmitter/LibreTransmitter/NotificationHelperOverride.swift << 'EOF'
          //
          //  NotificationHelperOverride.swift
          //  LibreTransmitter
          //
          //  Created by Bjørn Inge Berg on 16/01/2023.
          //  Copyright © 2023 Mark Wilson. All rights reserved.
          //

          import Foundation
          enum NotificationHelperOverride {
              static var shouldOverrideRequestCriticalPermissions : Bool {
                  // if you want LibreTransmitter to try upgrading to critical notifications, change this
                  false
              }
          }
          EOF

      - name: Build Loop
        run: bundle exec fastlane build_loop
        env:
          TEAMID: ${{ secrets.TEAMID }}
          FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
          FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
          FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}

      - name: Upload to TestFlight
        run: bundle exec fastlane release
        env:
          FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
          FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
          FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            artifacts/
            buildlog/
          retention-days: 30

      - name: Build Success
        run: |
          echo "=========================================="
          echo "✅ Build completed successfully!"
          echo "=========================================="
          echo ""
          echo "Your app has been uploaded to TestFlight."
          echo ""
          echo "Next steps:"
          echo "1. Go to App Store Connect: https://appstoreconnect.apple.com/apps"
          echo "2. Add testers to your TestFlight Internal Testing group"
          echo "3. Install the TestFlight app on your iPhone"
          echo "4. Accept the invitation and install Loop"
          echo ""
          echo "Build artifacts have been saved for 30 days."
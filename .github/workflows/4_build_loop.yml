name: 4. Build Loop
run-name: Build Loop
on:
  workflow_dispatch:
  schedule:
    # Weekly check for updates - Wednesdays at 08:00 UTC
    - cron: '0 8 * * 3'
    # Monthly build - 1st of month at 06:00 UTC
    - cron: '0 6 1 * *'

jobs:
  # Keep repository alive by committing to alive branch
  keep_alive:
    name: Keep Alive
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && vars.SCHEDULED_BUILD != 'false' && vars.SCHEDULED_SYNC != 'false'
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          ref: alive

      - name: Keep Alive Commit
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create dummy commit
          echo "Keep alive commit on $(date)" >> keep_alive.txt
          git add keep_alive.txt
          git commit -m "Keep alive: $(date)" || echo "No changes to commit"
          
          # Push changes
          git push origin alive
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

  # Check for updates and sync repository
  check_update:
    name: Check for Updates
    runs-on: ubuntu-latest
    if: (github.event_name == 'schedule' && vars.SCHEDULED_SYNC != 'false') || github.event_name == 'workflow_dispatch'
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Updates
        id: check
        run: |
          # Fetch latest from upstream
          git remote add upstream https://github.com/LoopKit/LoopWorkspace.git || true
          git fetch upstream
          
          # Check if there are new commits
          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse upstream/main)
          
          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "Updates found!"
            echo "should_build=true" >> $GITHUB_OUTPUT
            
            # Sync with upstream if this is a scheduled run
            if [ "${{ github.event_name }}" = "schedule" ]; then
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git merge upstream/main --no-edit
              git push origin main
            fi
          else
            echo "No updates found"
            # Monthly build should always build
            if [ "${{ github.event.schedule }}" = "0 6 1 * *" ]; then
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          fi

  # Check and renew certificates if needed
  check_certs:
    name: Check Certificates
    runs-on: macos-15
    if: needs.check_update.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    needs: check_update
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Check and Renew Certificates
        if: vars.ENABLE_NUKE_CERTS == 'true'
        run: |
          bundle exec fastlane check_and_renew_certificates
          
          if [ -f "new_certificate_needed.txt" ]; then
            NEED_NUKE=$(cat new_certificate_needed.txt)
            if [ "$NEED_NUKE" = "true" ]; then
              echo "⚠️  Certificates need renewal"
              bundle exec fastlane nuke_certs
              bundle exec fastlane certs
            fi
          fi
        env:
          TEAMID: ${{ secrets.TEAMID }}
          FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
          FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
          FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}

  # Build Loop
  build:
    name: Build
    runs-on: macos-15
    if: needs.check_update.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    needs: [check_update, check_certs]
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Verify Xcode and Install iOS Platforms
        run: |
          echo "=========================================="
          echo "Xcode Setup"
          echo "=========================================="
          echo "Selected Xcode version:"
          xcodebuild -version
          
          # 确保使用正确的 Xcode
          export DEVELOPER_DIR=$(xcode-select -p)
          echo "Developer directory: $DEVELOPER_DIR"
          
          # 接受 Xcode 许可协议（如果尚未接受）
          echo ""
          echo "Accepting Xcode license agreement..."
          sudo xcodebuild -license accept || echo "License may already be accepted"
          
          # 运行 Xcode 首次启动以安装必要组件
          echo ""
          echo "Running Xcode first launch..."
          sudo xcodebuild -runFirstLaunch || true
          
          # 等待 Xcode 完成初始化
          sleep 10
          
          # 尝试安装所有平台（这会安装 iOS 18.0 和 watchOS 11.0 如果可用）
          echo ""
          echo "Installing iOS and watchOS platforms..."
          
          # 方法1: 尝试使用 xcodebuild -downloadAllPlatforms
          echo "Method 1: Trying -downloadAllPlatforms..."
          if sudo xcodebuild -downloadAllPlatforms 2>&1; then
            echo "✅ downloadAllPlatforms completed"
          else
            echo "⚠️ downloadAllPlatforms failed, trying individual platform install..."
            
            # 方法2: 尝试单独安装 iOS 平台（多次尝试）
            echo ""
            echo "Method 2: Trying -downloadPlatform iOS (attempt 1)..."
            sudo xcodebuild -downloadPlatform iOS 2>&1 || echo "⚠️ iOS platform install attempt 1 failed"
            sleep 10
            
            echo "Method 2: Trying -downloadPlatform iOS (attempt 2)..."
            sudo xcodebuild -downloadPlatform iOS 2>&1 || echo "⚠️ iOS platform install attempt 2 failed"
            sleep 10
            
            # 方法3: 尝试多次安装 iOS 平台
            echo ""
            echo "Method 3: Multiple attempts to install iOS platform..."
            for i in {1..3}; do
              echo "iOS platform install attempt $i..."
              sudo xcodebuild -downloadPlatform iOS 2>&1 && break || echo "⚠️ iOS platform install attempt $i failed"
              sleep 10
            done
            
            # 尝试单独安装 watchOS 平台
            echo ""
            echo "Installing watchOS platform..."
            sudo xcodebuild -downloadPlatform watchOS 2>&1 || echo "⚠️ watchOS platform install failed"
          fi
          
          # 等待安装完成
          echo ""
          echo "Waiting for platform installation to complete..."
          sleep 30  # 增加等待时间
          
          # 再次尝试安装 iOS 平台以确保它被正确安装
          echo ""
          echo "Final attempt: Verifying and reinstalling iOS platform if needed..."
          sudo xcodebuild -downloadPlatform iOS 2>&1 || echo "⚠️ iOS platform final reinstall attempt failed"
          
          # 再次等待
          sleep 20  # 增加等待时间
          
          # 验证平台安装是否成功
          echo ""
          echo "Verifying platform installation..."
          xcodebuild -showsdks 2>&1 | head -20
          
          # 检查平台目录的完整性
          echo ""
          echo "Checking platform directory structure..."
          XCODE_PATH=$(xcode-select -p | sed 's|/Contents/Developer||')
          IOS_PLATFORM_PATH="$XCODE_PATH/Contents/Developer/Platforms/iPhoneOS.platform"
          if [ -d "$IOS_PLATFORM_PATH" ]; then
            echo "✅ iOS platform directory exists"
            echo "Checking for key files..."
            [ -f "$IOS_PLATFORM_PATH/Info.plist" ] && echo "✅ Info.plist exists" || echo "⚠️ Info.plist missing"
            [ -d "$IOS_PLATFORM_PATH/Developer/SDKs" ] && echo "✅ SDKs directory exists" || echo "⚠️ SDKs directory missing"
            ls -la "$IOS_PLATFORM_PATH/Developer/SDKs" 2>/dev/null | head -5 || echo "⚠️ Cannot list SDKs"
          fi
          
          # 尝试列出 destinations 以验证平台是否被识别
          echo ""
          echo "Testing destination detection..."
          if [ -f "LoopWorkspace.xcworkspace/contents.xcworkspacedata" ]; then
            xcodebuild -workspace LoopWorkspace.xcworkspace -scheme LoopWorkspace -showdestinations -configuration Release 2>&1 | head -50 || echo "⚠️ Cannot show destinations"
          else
            echo "⚠️ Workspace not found, skipping destination test"
          fi
          
          # 设置环境变量以确保 xcodebuild 使用正确的路径
          export DEVELOPER_DIR=$(xcode-select -p)
          echo ""
          echo "Final DEVELOPER_DIR: $DEVELOPER_DIR"
          
          # 检查可用的 iOS SDK
          echo ""
          echo "Available iOS SDKs:"
          xcodebuild -showsdks | grep -i ios || echo "⚠️ No iOS SDKs found"
          
          # 检查可用的 watchOS SDK
          echo ""
          echo "Available watchOS SDKs:"
          xcodebuild -showsdks | grep -i watchos || echo "⚠️ No watchOS SDKs found"
          
          # 获取当前 iOS SDK 版本并验证
          IOS_SDK_VERSION=$(xcrun --sdk iphoneos --show-sdk-version 2>/dev/null || echo "")
          if [ -z "$IOS_SDK_VERSION" ]; then
            echo "❌ iOS SDK version not found - platform installation may have failed"
            echo "This will cause the build to fail. Please check the platform installation steps above."
            exit 1
          else
            echo "✅ iOS SDK version: $IOS_SDK_VERSION"
            # 验证是否是 iOS 18.0 或更高版本（Xcode 16.0 应该包含 iOS 18.0）
            if [[ "$IOS_SDK_VERSION" == 18.* ]] || [[ "$IOS_SDK_VERSION" == 1[89].* ]] || [[ "$IOS_SDK_VERSION" == 2*.* ]]; then
              echo "✅ iOS SDK version is 18.0 or higher, which is correct for Xcode 16.0"
            else
              echo "⚠️ iOS SDK version is $IOS_SDK_VERSION, expected 18.0 or higher for Xcode 16.0"
              echo "This may cause build issues, but continuing..."
            fi
          fi
          
          # 获取当前 watchOS SDK 版本
          WATCHOS_SDK_VERSION=$(xcrun --sdk watchos --show-sdk-version 2>/dev/null || echo "")
          if [ -z "$WATCHOS_SDK_VERSION" ]; then
            echo "⚠️ watchOS SDK version not found"
          else
            echo "✅ watchOS SDK version: $WATCHOS_SDK_VERSION"
          fi
          
          # 检查 iOS 平台目录（必须存在，否则构建会失败）
          echo ""
          echo "Checking iOS platform directory:"
          XCODE_PATH=$(xcode-select -p | sed 's|/Contents/Developer||')
          IOS_PLATFORM_PATH="$XCODE_PATH/Contents/Developer/Platforms/iPhoneOS.platform"
          if [ -d "$IOS_PLATFORM_PATH" ]; then
            echo "✅ iOS platform directory exists: $IOS_PLATFORM_PATH"
            ls -la "$IOS_PLATFORM_PATH" | head -5
            
            # 验证关键文件是否存在
            if [ ! -f "$IOS_PLATFORM_PATH/Info.plist" ]; then
              echo "❌ iOS platform Info.plist missing - platform installation incomplete"
              exit 1
            fi
            if [ ! -d "$IOS_PLATFORM_PATH/Developer/SDKs" ]; then
              echo "❌ iOS platform SDKs directory missing - platform installation incomplete"
              exit 1
            fi
            SDK_COUNT=$(ls -1 "$IOS_PLATFORM_PATH/Developer/SDKs" 2>/dev/null | wc -l | tr -d ' ')
            if [ "$SDK_COUNT" -eq 0 ]; then
              echo "❌ No iOS SDKs found in platform directory - platform installation incomplete"
              exit 1
            else
              echo "✅ Found $SDK_COUNT iOS SDK(s) in platform directory"
            fi
          else
            echo "❌ iOS platform directory not found: $IOS_PLATFORM_PATH"
            echo "This will cause the build to fail. Platform installation did not complete successfully."
            exit 1
          fi
          
          # 检查 watchOS 平台目录
          echo ""
          echo "Checking watchOS platform directory:"
          WATCHOS_PLATFORM_PATH="$XCODE_PATH/Contents/Developer/Platforms/WatchOS.platform"
          if [ -d "$WATCHOS_PLATFORM_PATH" ]; then
            echo "✅ watchOS platform directory exists: $WATCHOS_PLATFORM_PATH"
            ls -la "$WATCHOS_PLATFORM_PATH" | head -5
          else
            echo "⚠️ watchOS platform directory not found: $WATCHOS_PLATFORM_PATH"
            exit 1 # Fail the step if watchOS platform is not found
          fi
          
          echo ""
          echo "=========================================="
          echo "Setup Complete"
          echo "=========================================="

      - name: Fix Swift 6 Compatibility for Xcode 15.4
        run: |
          echo "Removing @retroactive attributes for Xcode 15.4 compatibility..."
          
          # Remove @retroactive from all Swift files
          find Loop -name "*.swift" -type f -exec grep -l "@retroactive" {} \; | while read file; do
            echo "Fixing $file..."
            sed -i '' 's/@retroactive //g' "$file"
          done
          
          echo "✅ Swift 6 compatibility fixes applied"

      - name: Fix WatchApp Bundle ID Configuration
        run: |
          echo "Fixing WatchApp and WatchApp Extension Bundle ID configuration..."
          
          MAIN_BUNDLE_ID="com.libre.loopkit3.Loop"
          
          # Fix WKAppBundleIdentifier in WatchApp Extension Info.plist
          WATCH_EXTENSION_PLIST="Loop/WatchApp Extension/Info.plist"
          if [ -f "$WATCH_EXTENSION_PLIST" ]; then
            sed -i '' "s/\$(MAIN_APP_BUNDLE_IDENTIFIER)/${MAIN_BUNDLE_ID}/g" "$WATCH_EXTENSION_PLIST"
            echo "✅ Fixed WatchApp Extension Info.plist"
            grep "WKAppBundleIdentifier" -A 1 "$WATCH_EXTENSION_PLIST"
          fi
          
          # Fix WKCompanionAppBundleIdentifier in WatchApp Info.plist
          WATCH_APP_PLIST="Loop/WatchApp/Info.plist"
          if [ -f "$WATCH_APP_PLIST" ]; then
            sed -i '' "s/\$(MAIN_APP_BUNDLE_IDENTIFIER)/${MAIN_BUNDLE_ID}/g" "$WATCH_APP_PLIST"
            echo "✅ Fixed WatchApp Info.plist"
            grep "WKCompanionAppBundleIdentifier" -A 1 "$WATCH_APP_PLIST"
          fi
          
          echo "✅ WatchApp Bundle ID configuration fixed"

      - name: Create NotificationHelperOverride.swift
        run: |
          cat > LibreTransmitter/LibreTransmitter/NotificationHelperOverride.swift << 'EOF'
          //
          //  NotificationHelperOverride.swift
          //  LibreTransmitter
          //
          //  Created by Bjørn Inge Berg on 16/01/2023.
          //  Copyright © 2023 Mark Wilson. All rights reserved.
          //

          import Foundation
          enum NotificationHelperOverride {
              static var shouldOverrideRequestCriticalPermissions : Bool {
                  // if you want LibreTransmitter to try upgrading to critical notifications, change this
                  false
              }
          }
          EOF

      - name: Build Loop
        run: bundle exec fastlane build_loop
        env:
          TEAMID: ${{ secrets.TEAMID }}
          FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
          FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
          FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}

      - name: Upload to TestFlight
        run: bundle exec fastlane release
        env:
          FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
          FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
          FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            artifacts/
            buildlog/
          retention-days: 30

      - name: Build Success
        run: |
          echo "=========================================="
          echo "✅ Build completed successfully!"
          echo "=========================================="
          echo ""
          echo "Your app has been uploaded to TestFlight."
          echo ""
          echo "Next steps:"
          echo "1. Go to App Store Connect: https://appstoreconnect.apple.com/apps"
          echo "2. Add testers to your TestFlight Internal Testing group"
          echo "3. Install the TestFlight app on your iPhone"
          echo "4. Accept the invitation and install Loop"
          echo ""
          echo "Build artifacts have been saved for 30 days."

